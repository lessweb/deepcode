<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src {{cspSource}} data:; style-src {{cspSource}} 'unsafe-inline'; script-src 'nonce-{{nonce}}';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Code</title>
  <style>
    :root {
      --bg: var(--vscode-editor-background);
      --panel: var(--vscode-sideBar-background);
      --panel-2: var(--vscode-editor-inactiveSelectionBackground);
      --text: var(--vscode-list-hoverForeground);
      --muted: var(--vscode-descriptionForeground);
      --accent: var(--vscode-focusBorder);
      --accent-2: var(--vscode-button-background);
      --danger: var(--vscode-errorForeground);
      --shadow: rgba(0, 0, 0, 0.2);
      --border-color: var(--vscode-panel-border);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: var(--bg);
      color: var(--text);
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
    }

    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 14px 16px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--muted);
      background: var(--vscode-titleBar-activeBackground);
      border-bottom: 1px solid var(--border-color);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--vscode-sideBar-background);
    }

    .bubble {
      padding: 12px 10px;
      border-radius: 10px;
      font-size: 13px;
      line-height: normal;
      max-width: 85%;
    }

    .bubble.user {
      align-self: flex-end;
      background: color-mix(in srgb, var(--vscode-editor-inactiveSelectionBackground) 60%, transparent);
      color: var(--text);
    }

    .bubble.assistant {
      align-self: flex-start;
      background: color-mix(in srgb, var(--vscode-editor-inactiveSelectionBackground) 40%, transparent);
    }

    .bubble.assistant pre {
      padding: 10px;
      border-radius: 10px;
      overflow-x: auto;
      color: var(--text);
    }

    .bubble.assistant code {
      font-family: var(--vscode-editor-font-family);
      font-size: 12px;
    }

    .bubble.user pre {
      padding: 10px;
      border-radius: 10px;
      overflow-x: auto;
      color: var(--text);
    }

    .bubble.user code {
      font-family: var(--vscode-editor-font-family);
      font-size: 12px;
    }

    .composer {
      padding: 12px 16px 16px;
      background: var(--vscode-sideBar-background);
      flex-shrink: 0;
    }

    .input-wrap {
      position: relative;
    }

    textarea {
      width: 100%;
      min-height: 72px;
      resize: vertical;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      padding: 10px 12px 28px 12px;
      font-size: 13px;
      line-height: 1.4;
      outline: none;
      font-family: var(--vscode-font-family);
      resize: none;
      border: 1px solid var(--border-color);
    }

    textarea:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
    }

    textarea::placeholder {
      color: var(--vscode-input-placeholderForeground);
    }

    .send-button {
      position: absolute;
      right: 10px;
      bottom: 10px;
      width: 22px;
      height: 22px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      display: grid;
      place-items: center;
      background: transparent;
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-icon {
      width: 16px;
      height: 16px;
      fill: var(--text);
      transition: opacity 0.2s;
    }

    .send-icon.empty {
      opacity: 0.6;
    }

    .header-back-icon,
    .header-new-icon {
      fill: var(--text);
    }

    .loading {
      display: none;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
      padding: 16px 10px;
      flex-shrink: 0;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid var(--vscode-progressBar-background);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: var(--vscode-titleBar-activeBackground);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .header-back-btn {
      background: none;
      border: none;
      color: var(--vscode-editor-foreground);
      cursor: pointer;
      padding: 4px;
      display: none;
      font-size: 16px;
    }

    .header-back-btn.show {
      display: block;
    }

    .header-title {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--vscode-descriptionForeground);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .header-new-btn {
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .sessions-list {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .sessions-list.show {
      display: flex;
    }

    .session-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }

    .session-item:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .session-item-summary {
      font-size: 13px;
      color: var(--vscode-editor-foreground);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-item-time {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .chat-container.hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-container">
      <div class="header-left">
        <button class="header-back-btn" id="backBtn" title="Back to sessions">
          <svg class="header-back-icon" viewBox="0 0 1024 1024" width="16" height="16" aria-hidden="true">
            <path d="M156.608 487.8592c1.156267-1.137067 2.648533-1.6224 3.918933-2.558933l306.666667-301.569067c13.195733-12.970667 34.586667-12.970667 47.781333 0 13.194667 12.978133 13.194667 34.013867 0 46.987733L263.3024 478.210133l579.2032 0c18.978133 0 34.362667 15.128533 34.362667 33.789867 0 18.6624-15.384533 33.793067-34.362667 33.793067L263.3024 545.793067l251.671467 247.486933c13.194667 12.971733 13.194667 34.010667 0 46.984533-13.194667 12.974933-34.586667 12.974933-47.781333 0l-306.666667-301.5616c-1.269333-0.939733-2.762667-1.421867-3.918933-2.562133-6.334933-6.2304-9.240533-14.340267-9.477333-22.5024C147.367467 502.200533 150.273067 494.090667 156.608 487.8592L156.608 487.8592zM156.608 487.8592"></path>
          </svg>
        </button>
        <div class="header-title" id="headerTitle">Deep Code</div>
      </div>
      <button class="header-new-btn" id="newSessionBtn" title="New chat">
        <svg class="header-new-icon" viewBox="0 0 1024 1024" width="14" height="14" aria-hidden="true">
          <path d="M474 152m8 0l60 0q8 0 8 8l0 704q0 8-8 8l-60 0q-8 0-8-8l0-704q0-8 8-8Z"></path>
          <path d="M168 474m8 0l672 0q8 0 8 8l0 60q0 8-8 8l-672 0q-8 0-8-8l0-60q0-8 8-8Z"></path>
        </svg>
      </button>
    </div>

    <!-- 对话列表视图 -->
    <div class="sessions-list" id="sessionsList"></div>

    <!-- 聊天视图 -->
    <div class="chat-container" id="chatContainer">
      <div class="messages" id="messages"></div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Thinking...</span>
      </div>
      <div class="composer">
        <div class="input-wrap">
          <textarea id="prompt" placeholder="Write a prompt..." rows="3"></textarea>
          <button class="send-button" id="send" title="Send">
            <svg class="send-icon" id="sendIcon" viewBox="0 0 1024 1024" aria-hidden="true">
              <path d="M242.944 512L98.090667 139.605333c-10.069333-25.898667 15.189333-50.688 40.192-41.898666l3.968 1.706666 768 384a32 32 0 0 1 4.138666 54.741334l-4.138666 2.474666-768 384c-24.874667 12.416-51.925333-10.410667-45.44-36.138666l1.28-4.096L242.944 512 98.090667 139.605333 242.944 512zM187.818667 193.706667l111.36 286.293333h282.752a32 32 0 0 1 31.701333 27.648l0.298667 4.352a32 32 0 0 1-27.690667 31.701333l-4.309333 0.298667H299.093333l-111.317333 286.293333L824.405333 512 187.776 193.706667z" />
            </svg>
            <svg class="send-icon" id="stopIcon" viewBox="0 0 1024 1024" aria-hidden="true" style="display: none;">
              <path d="M777.6 553.6H246.4c-22.4 0-38.4-19.2-38.4-38.4 0-22.4 19.2-38.4 38.4-38.4h528c22.4 0 38.4 19.2 38.4 38.4 3.2 19.2-16 38.4-35.2 38.4z"></path>
              <path d="M512 1024C230.4 1024 0 793.6 0 512S230.4 0 512 0s512 230.4 512 512-230.4 512-512 512z m0-950.4C268.8 73.6 73.6 268.8 73.6 512S268.8 950.4 512 950.4 950.4 755.2 950.4 512 755.2 73.6 512 73.6z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script nonce="{{nonce}}">
    const vscode = acquireVsCodeApi();
    const messages = document.getElementById("messages");
    const promptInput = document.getElementById("prompt");
    const sendButton = document.getElementById("send");
    const loading = document.getElementById("loading");
    const sessionsList = document.getElementById("sessionsList");
    const chatContainer = document.getElementById("chatContainer");
    const headerTitle = document.getElementById("headerTitle");
    const backBtn = document.getElementById("backBtn");
    const newSessionBtn = document.getElementById("newSessionBtn");
    const sendIcon = document.getElementById("sendIcon");
    const stopIcon = document.getElementById("stopIcon");

    let currentSessionId = null;
    let isProcessing = false;

    function addBubble(content, role) {
      const bubble = document.createElement("div");
      bubble.className = "bubble " + role;
      bubble.innerHTML = content;
      messages.appendChild(bubble);
      messages.scrollTop = messages.scrollHeight;
    }

    function setLoading(isLoading) {
      loading.classList.toggle("active", isLoading);
      isProcessing = isLoading;
      
      // 切换图标
      if (isLoading) {
        sendIcon.style.display = "none";
        stopIcon.style.display = "block";
        sendButton.title = "Stop";
      } else {
        sendIcon.style.display = "block";
        stopIcon.style.display = "none";
        sendButton.title = "Send";
      }
      
      updateSendIconState();
    }

    function updateSendIconState() {
      const hasContent = promptInput.value.trim().length > 0;
      if (!isProcessing) {
        sendIcon.classList.toggle("empty", !hasContent);
        sendButton.disabled = false;
      } else {
        sendButton.disabled = false; // 允许点击中断
      }
    }

    function clearMessages() {
      messages.innerHTML = "";
    }

    function showChat() {
      chatContainer.classList.remove("hidden");
      sessionsList.classList.remove("show");
      backBtn.classList.add("show");
    }

    function showSessionsList(sessions) {
      chatContainer.classList.add("hidden");
      sessionsList.classList.add("show");
      backBtn.classList.remove("show");
      headerTitle.textContent = "All Conversations";
      sessionsList.innerHTML = "";

      sessions.reverse().forEach((session) => {
        const item = document.createElement("div");
        item.className = "session-item";
        const date = new Date(session.updateTime).toLocaleString();
        item.innerHTML = `
          <div class="session-item-summary">${session.summary}</div>
          <div class="session-item-time">${date}</div>
        `;
        item.addEventListener("click", () => {
          vscode.postMessage({ type: "selectSession", sessionId: session.id });
        });
        sessionsList.appendChild(item);
      });
    }

    promptInput.addEventListener("input", updateSendIconState);
    updateSendIconState();

    function sendPrompt() {
      const text = promptInput.value.trim();
      if (!text || (sendButton.disabled && !isProcessing)) {
        return;
      }

      // 如果正在处理，则中断
      if (isProcessing) {
        vscode.postMessage({ type: "interrupt" });
        return;
      }

      // 发送消息，不立即显示（等待后端返回渲染后的 HTML）
      promptInput.value = "";
      vscode.postMessage({ type: "userPrompt", prompt: text });
      updateSendIconState();
    }

    backBtn.addEventListener("click", () => {
      vscode.postMessage({ type: "backToList" });
    });

    newSessionBtn.addEventListener("click", () => {
      vscode.postMessage({ type: "createNewSession" });
    });

    sendButton.addEventListener("click", sendPrompt);
    promptInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        if (event.shiftKey) {
          // Shift+回车：允许换行（默认行为）
          return;
        } else {
          // 回车：发送消息
          event.preventDefault();
          sendPrompt();
        }
      }
    });

    window.addEventListener("message", (event) => {
      const message = event.data;
      if (message.type === "initializeEmpty") {
        // 初始化空聊天
        clearMessages();
        showChat();
        headerTitle.textContent = "New Conversation";
        currentSessionId = null;
      } else if (message.type === "loadSession") {
        // 加载已有对话
        currentSessionId = message.sessionId;
        clearMessages();
        showChat();
        headerTitle.textContent = message.summary;
        // 加载历史消息
        if (message.messages && Array.isArray(message.messages)) {
          message.messages.forEach((msg) => {
            if (msg.role === "user") {
              addBubble(msg.html || msg.content, "user");
            } else if (msg.role === "assistant") {
              addBubble(msg.html || msg.content, "assistant");
            }
          });
        }
      } else if (message.type === "showSessionsList") {
        // 显示对话列表
        showSessionsList(message.sessions || []);
      } else if (message.type === "userMessage") {
        // 显示用户消息
        addBubble(message.html || "", "user");
      } else if (message.type === "assistant") {
        // 接收助手回复
        addBubble(message.html || "", "assistant");
      } else if (message.type === "loading") {
        // 加载状态
        setLoading(Boolean(message.value));
      }
    });

    // webview 准备就绪，请求初始数据
    vscode.postMessage({ type: "ready" });
  </script>
</body>
</html>
