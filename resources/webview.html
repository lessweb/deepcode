<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src {{cspSource}} data:; style-src {{cspSource}} 'unsafe-inline'; script-src 'nonce-{{nonce}}';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Code</title>
  <link rel="stylesheet" href="{{cssUri}}">
</head>
<body>
  <div class="app">
    <div class="header-container">
      <div class="header-left">
        <div class="session-selector" id="sessionSelector">
          <div class="session-selector-title" id="sessionSelectorTitle">Deep Code</div>
          <svg class="session-selector-icon" viewBox="0 0 1024 1024" aria-hidden="true">
            <path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path>
          </svg>
        </div>
      </div>
      <button class="header-new-btn" id="newSessionBtn" title="New chat">
        <svg class="header-new-icon" viewBox="0 0 1024 1024" width="16" height="16" aria-hidden="true">
          <path d="M474 152m8 0l60 0q8 0 8 8l0 704q0 8-8 8l-60 0q-8 0-8-8l0-704q0-8 8-8Z"></path>
          <path d="M168 474m8 0l672 0q8 0 8 8l0 60q0 8-8 8l-672 0q-8 0-8-8l0-60q0-8 8-8Z"></path>
        </svg>
      </button>
      <div class="session-dropdown" id="sessionDropdown"></div>
    </div>

    <!-- 聊天视图 -->
    <div class="chat-container" id="chatContainer">
      <div class="messages" id="messages"></div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <span>Thinking...</span>
      </div>
      <div class="composer">
        <div class="input-wrap">
          <textarea id="prompt" placeholder="Write a prompt..." rows="3"></textarea>
          <button class="send-button" id="send" title="Send">
            <svg class="send-icon" id="sendIcon" viewBox="0 0 1024 1024" aria-hidden="true">
              <path d="M242.944 512L98.090667 139.605333c-10.069333-25.898667 15.189333-50.688 40.192-41.898666l3.968 1.706666 768 384a32 32 0 0 1 4.138666 54.741334l-4.138666 2.474666-768 384c-24.874667 12.416-51.925333-10.410667-45.44-36.138666l1.28-4.096L242.944 512 98.090667 139.605333 242.944 512zM187.818667 193.706667l111.36 286.293333h282.752a32 32 0 0 1 31.701333 27.648l0.298667 4.352a32 32 0 0 1-27.690667 31.701333l-4.309333 0.298667H299.093333l-111.317333 286.293333L824.405333 512 187.776 193.706667z" />
            </svg>
            <svg class="send-icon" id="stopIcon" viewBox="0 0 1024 1024" aria-hidden="true" style="display: none;">
              <path d="M777.6 553.6H246.4c-22.4 0-38.4-19.2-38.4-38.4 0-22.4 19.2-38.4 38.4-38.4h528c22.4 0 38.4 19.2 38.4 38.4 3.2 19.2-16 38.4-35.2 38.4z"></path>
              <path d="M512 1024C230.4 1024 0 793.6 0 512S230.4 0 512 0s512 230.4 512 512-230.4 512-512 512z m0-950.4C268.8 73.6 73.6 268.8 73.6 512S268.8 950.4 512 950.4 950.4 755.2 950.4 512 755.2 73.6 512 73.6z"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

<script nonce="{{nonce}}">
  const vscode = acquireVsCodeApi();
  const messages = document.getElementById("messages");
  const promptInput = document.getElementById("prompt");
  const sendButton = document.getElementById("send");
  const loading = document.getElementById("loading");
  const chatContainer = document.getElementById("chatContainer");
  const sessionSelector = document.getElementById("sessionSelector");
  const sessionSelectorTitle = document.getElementById("sessionSelectorTitle");
  const sessionDropdown = document.getElementById("sessionDropdown");
  const newSessionBtn = document.getElementById("newSessionBtn");
  const sendIcon = document.getElementById("sendIcon");
  const stopIcon = document.getElementById("stopIcon");

  let currentSessionId = null;
  let currentSessionStatus = null;
  let allSessions = [];
  let sessionSearchInput = null;
  let sessionDropdownList = null;
  let lastMessageRole = null;

  function isProcessing() {
    return currentSessionStatus === "processing" || currentSessionStatus === "pending";
  }

  function addBubble(content, role, meta, shouldConnectToPrev = false) {
    const bubble = document.createElement("div");
    bubble.className = "bubble " + role;

    if (role === "user") {
      // 普通用户气泡
      bubble.innerHTML = content;
    } else if (role === "assistant") {
      if (meta && meta.asThinking === true) {
        // 思考气泡（可折叠）
        const header = document.createElement("div");
        header.className = "bubble-collapsible-header";
        const dotClass = shouldConnectToPrev ? "bubble-dot connect-to-prev" : "bubble-dot";
        header.innerHTML = `
          <span class="${dotClass}"></span>
          <span class="bubble-title">
            <span class="bubble-title-text">Thinking</span>
            <span class="bubble-toggle">
              <svg viewBox="0 0 1024 1024" aria-hidden="true">
                <path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path>
              </svg>
            </span>
          </span>
        `;

        const contentDiv = document.createElement("div");
        contentDiv.className = "bubble-collapsible-content collapsed";
        contentDiv.innerHTML = content;

        header.addEventListener("click", () => {
          const isCollapsed = contentDiv.classList.toggle("collapsed");
          const toggleBtn = header.querySelector(".bubble-toggle");
          if (isCollapsed) {
            toggleBtn.classList.remove("expanded");
          } else {
            toggleBtn.classList.add("expanded");
          }
          // 折叠/展开后重新计算所有连接线
          requestAnimationFrame(() => {
            updateAllConnectionLines();
          });
        });

        bubble.appendChild(header);
        bubble.appendChild(contentDiv);
      } else {
        // 普通assistant气泡（带圆点但不折叠）
        const dot = document.createElement("span");
        dot.className = shouldConnectToPrev ? "bubble-dot connect-to-prev" : "bubble-dot";

        const contentDiv = document.createElement("div");
        contentDiv.className = "bubble-normal-content";
        contentDiv.innerHTML = content;

        bubble.appendChild(dot);
        bubble.appendChild(contentDiv);
      }
    } else if (role === "tool") {
      // 工具气泡（可折叠）
      let toolData = { ok: false, name: "unknown", output: "" };
      try {
        // content是JSON字符串，包含ok、name、output等字段
        toolData = JSON.parse(content || "{}");
      } catch (e) {
        // 忽略解析错误
      }

      const isOk = toolData.ok === true;
      const toolName = toolData.name || "unknown";
      const paramsMd = (meta?.paramsMd || "").trim();
      const resultMd = (meta?.resultMd || "").trim();

      const header = document.createElement("div");
      header.className = "bubble-collapsible-header";

      const titleText = paramsMd
        ? `<b>${escapeHtml(toolName)}</b> <span class="tool-params">${escapeHtml(paramsMd)}</span>`
        : `<b>${escapeHtml(toolName)}</b>`;

      const dotClasses = ["bubble-dot"];
      if (isOk) dotClasses.push("success");
      else dotClasses.push("error");
      if (shouldConnectToPrev) dotClasses.push("connect-to-prev");

      header.innerHTML = `
        <span class="${dotClasses.join(' ')}"></span>
        <span class="bubble-title">
          <span class="bubble-title-text">${titleText}</span>
          <span class="bubble-toggle">
            <svg viewBox="0 0 1024 1024" aria-hidden="true">
              <path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path>
            </svg>
          </span>
        </span>
      `;

      const contentDiv = document.createElement("div");
      contentDiv.className = "bubble-collapsible-content collapsed";

      // 优先显示resultMd，其次是output，最后是完整content
      let displayContent = resultMd;
      if (!displayContent && toolData.output) {
        displayContent = typeof toolData.output === 'string'
          ? toolData.output
          : JSON.stringify(toolData.output, null, 2);
      }
      if (!displayContent) {
        displayContent = content;
      }

      contentDiv.textContent = displayContent;

      header.addEventListener("click", () => {
        const isCollapsed = contentDiv.classList.toggle("collapsed");
        const toggleBtn = header.querySelector(".bubble-toggle");
        if (isCollapsed) {
          toggleBtn.classList.remove("expanded");
        } else {
          toggleBtn.classList.add("expanded");
        }
        // 折叠/展开后重新计算所有连接线
        requestAnimationFrame(() => {
          updateAllConnectionLines();
        });
      });

      bubble.appendChild(header);
      bubble.appendChild(contentDiv);
    }

    messages.appendChild(bubble);
    messages.scrollTop = messages.scrollHeight;
    lastMessageRole = role;

    // 如果需要连接线，动态计算并设置连接线高度
    if (shouldConnectToPrev && role !== "user") {
      requestAnimationFrame(() => {
        updateConnectionLine(bubble);
      });
    }
  }

  function updateConnectionLine(currentBubble) {
    // 找到当前气泡的圆点
    const currentDot = currentBubble.querySelector('.bubble-dot.connect-to-prev');
    if (!currentDot) return;

    // 找到上一个气泡
    const prevBubble = currentBubble.previousElementSibling;
    if (!prevBubble) return;

    // 找到上一个气泡的圆点
    const prevDot = prevBubble.querySelector('.bubble-dot');
    if (!prevDot) return;

    // 计算两个圆点之间的距离
    const currentRect = currentDot.getBoundingClientRect();
    const prevRect = prevDot.getBoundingClientRect();
    const distance = currentRect.top - prevRect.bottom;

    // 设置连接线高度（加上圆点的半径补偿）
    if (distance > 0) {
      currentDot.style.setProperty('--line-height', `${distance}px`);
    }
  }

  function updateAllConnectionLines() {
    const bubbles = messages.querySelectorAll('.bubble');
    bubbles.forEach(bubble => {
      updateConnectionLine(bubble);
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function setLoading(isLoading, status) {
    loading.classList.toggle("active", isLoading);
    if (status !== undefined) {
      currentSessionStatus = status;
    }

    // 切换图标
    if (isLoading) {
      sendIcon.style.display = "none";
      stopIcon.style.display = "block";
      sendButton.title = "Stop";
    } else {
      sendIcon.style.display = "block";
      stopIcon.style.display = "none";
      sendButton.title = "Send";
    }

    updateSendIconState();
  }

  function updateSendIconState() {
    const hasContent = promptInput.value.trim().length > 0;
    if (!isProcessing()) {
      sendIcon.classList.toggle("empty", !hasContent);
      sendButton.disabled = false;
    } else {
      sendButton.disabled = false; // 允许点击中断
    }
  }

  function clearMessages() {
    messages.innerHTML = "";
    lastMessageRole = null;
  }

  function updateSessionDropdown(sessions) {
    allSessions = sessions || [];
    sessionDropdown.innerHTML = "";

    // 创建搜索框
    const searchBox = document.createElement("div");
    searchBox.className = "session-search-box";
    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.className = "session-search-input";
    searchInput.placeholder = "Search sessions...";
    searchBox.appendChild(searchInput);
    sessionDropdown.appendChild(searchBox);

    // 创建列表容器
    const listContainer = document.createElement("div");
    listContainer.className = "session-dropdown-list";
    sessionDropdown.appendChild(listContainer);

    // 保存引用
    sessionSearchInput = searchInput;
    sessionDropdownList = listContainer;

    // 渲染所有会话
    renderFilteredSessions("");

    // 添加搜索事件
    searchInput.addEventListener("input", (e) => {
      renderFilteredSessions(e.target.value);
    });

    // 阻止搜索框点击事件冒泡
    searchInput.addEventListener("click", (e) => {
      e.stopPropagation();
    });
  }

  function renderFilteredSessions(searchQuery) {
    if (!sessionDropdownList) return;

    sessionDropdownList.innerHTML = "";
    const query = searchQuery.toLowerCase().trim();

    // 过滤会话
    const filteredSessions = allSessions.filter((session) => {
      const summary = (session.summary || "Untitled").toLowerCase();
      return summary.includes(query);
    });

    // 显示结果
    if (filteredSessions.length === 0) {
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "session-dropdown-empty";
      emptyDiv.textContent = query ? "No sessions found" : "No sessions yet";
      sessionDropdownList.appendChild(emptyDiv);
      return;
    }

    // 反转顺序（最新的在上面）
    const reversedSessions = [...filteredSessions].reverse();
    reversedSessions.forEach((session) => {
      const item = document.createElement("div");
      item.className = "session-dropdown-item";
      if (session.id === currentSessionId) {
        item.classList.add("active");
      }
      const date = new Date(session.updateTime).toLocaleString();

      // 高亮搜索关键字
      const summary = session.summary || "Untitled";
      const highlightedSummary = query
        ? summary.replace(new RegExp(`(${escapeRegExp(query)})`, 'gi'), '<mark>$1</mark>')
        : summary;

      item.innerHTML = `
        <div class="session-dropdown-summary">${highlightedSummary}</div>
        <div class="session-dropdown-time">${date}</div>
      `;
      item.addEventListener("click", () => {
        sessionDropdown.classList.remove("show");
        sessionSelector.classList.remove("open");
        vscode.postMessage({ type: "selectSession", sessionId: session.id });
      });
      sessionDropdownList.appendChild(item);
    });
  }

  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function toggleSessionDropdown() {
    const isOpen = sessionDropdown.classList.toggle("show");
    sessionSelector.classList.toggle("open", isOpen);

    // 打开时清空搜索框并聚焦
    if (isOpen && sessionSearchInput) {
      sessionSearchInput.value = "";
      renderFilteredSessions("");
      // 延迟聚焦，确保下拉框已完全显示
      setTimeout(() => {
        sessionSearchInput.focus();
      }, 100);
    }
  }

  // 点击其他地方关闭下拉框
  document.addEventListener("click", (event) => {
    if (!sessionSelector.contains(event.target) && !sessionDropdown.contains(event.target)) {
      sessionDropdown.classList.remove("show");
      sessionSelector.classList.remove("open");
    }
  });

  // 按 Escape 关闭下拉框
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && sessionDropdown.classList.contains("show")) {
      sessionDropdown.classList.remove("show");
      sessionSelector.classList.remove("open");
    }
  });

  promptInput.addEventListener("input", updateSendIconState);
  updateSendIconState();

  function sendPrompt() {
    // 如果正在处理，则中断（不检查输入框内容）
    if (isProcessing()) {
      vscode.postMessage({ type: "interrupt" });
      return;
    }

    // 检查输入内容
    const text = promptInput.value.trim();
    if (!text || sendButton.disabled) {
      return;
    }

    // 发送消息，不立即显示（等待后端返回渲染后的 HTML）
    promptInput.value = "";
    vscode.postMessage({ type: "userPrompt", prompt: text });
    updateSendIconState();
  }

  sessionSelector.addEventListener("click", (event) => {
    event.stopPropagation();
    toggleSessionDropdown();
  });

  newSessionBtn.addEventListener("click", () => {
    sessionDropdown.classList.remove("show");
    sessionSelector.classList.remove("open");
    vscode.postMessage({ type: "createNewSession" });
  });

  sendButton.addEventListener("click", sendPrompt);
  promptInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      if (event.shiftKey) {
        // Shift+回车：允许换行（默认行为）
        return;
      } else {
        // 回车：发送消息
        event.preventDefault();
        sendPrompt();
      }
    }
  });

  window.addEventListener("message", (event) => {
    const message = event.data;
    if (message.type === "initializeEmpty") {
      // 初始化空聊天
      clearMessages();
      sessionSelectorTitle.textContent = "New Conversation";
      currentSessionId = null;
      currentSessionStatus = message.status || null;
      setLoading(false, currentSessionStatus);
      // 如果消息中包含sessions，更新下拉框
      if (message.sessions && Array.isArray(message.sessions)) {
        updateSessionDropdown(message.sessions);
      } else if (allSessions.length > 0) {
        updateSessionDropdown(allSessions);
      }
    } else if (message.type === "loadSession") {
      // 加载已有对话
      currentSessionId = message.sessionId;
      clearMessages();
      sessionSelectorTitle.textContent = message.summary;
      
      // 加载历史消息
      if (message.messages && Array.isArray(message.messages)) {
        message.messages.forEach((msg, index) => {
          // 判断是否需要连接到上一个消息
          let shouldConnect = false;
          if (index > 0) {
            const prevMsg = message.messages[index - 1];
            shouldConnect = prevMsg.role !== "user" && msg.role !== "user";
          }

          if (msg.role === "user") {
            addBubble(msg.html || msg.content, "user", msg.meta, false);
          } else if (msg.role === "assistant") {
            addBubble(msg.html || msg.content, "assistant", msg.meta, shouldConnect);
          } else if (msg.role === "tool") {
            addBubble(msg.content, "tool", msg.meta, shouldConnect);
          }
        });

        // 更新 lastMessageRole 为最后一条消息的role
        if (message.messages.length > 0) {
          lastMessageRole = message.messages[message.messages.length - 1].role;
        }

        // 批量更新所有连接线的高度
        requestAnimationFrame(() => {
          updateAllConnectionLines();
        });
      }
      
      // 设置会话状态
      currentSessionStatus = message.status || null;
      const isCurrentlyProcessing = currentSessionStatus === "processing" || currentSessionStatus === "pending";
      setLoading(isCurrentlyProcessing, currentSessionStatus);
      
      // 如果消息中包含sessions，更新下拉框
      if (message.sessions && Array.isArray(message.sessions)) {
        updateSessionDropdown(message.sessions);
      } else if (allSessions.length > 0) {
        updateSessionDropdown(allSessions);
      }
    } else if (message.type === "showSessionsList") {
      // 更新对话列表下拉框
      updateSessionDropdown(message.sessions || []);
    } else if (message.type === "userMessage") {
      // 显示用户消息
      addBubble(message.html || "", "user", message.meta, false);
    } else if (message.type === "assistant") {
      // 接收助手回复
      const shouldConnect = lastMessageRole !== null && lastMessageRole !== "user";
      addBubble(message.html || "", "assistant", message.meta, shouldConnect);
    } else if (message.type === "loading") {
      // 加载状态
      const newStatus = message.value ? "processing" : currentSessionStatus;
      setLoading(Boolean(message.value), newStatus);
    }
  });

  // 监听窗口大小变化，重新计算连接线
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      updateAllConnectionLines();
    }, 100);
  });

  // webview 准备就绪，请求初始数据
  vscode.postMessage({ type: "ready" });
</script>
</body>
</html>
