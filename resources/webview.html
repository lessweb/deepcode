<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; img-src {{cspSource}} data:; style-src {{cspSource}} 'unsafe-inline'; script-src 'nonce-{{nonce}}';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deep Code</title>
  <style>
    :root {
      --bg: var(--vscode-editor-background);
      --panel: var(--vscode-sideBar-background);
      --panel-2: var(--vscode-editor-inactiveSelectionBackground);
      --muted: var(--vscode-descriptionForeground);
      --accent: var(--vscode-focusBorder);
      --accent-2: var(--vscode-button-background);
      --danger: var(--vscode-errorForeground);
      --shadow: rgba(0, 0, 0, 0.15);
      --border-color: var(--vscode-panel-border);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background: var(--bg);
      color: var(--vscode-foreground);
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
    }

    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 4px 16px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--muted);
      background: var(--vscode-sideBar-background);
      border-bottom: 1px solid var(--border-color);
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: var(--vscode-sideBar-background);
      padding: 16px;
    }

    .bubble {
      padding: 4px 6px;
      font-size: 13px;
      line-height: 1.6;
      width: 100%;
      border: 1px solid transparent;
      color: var(--vscode-foreground);
      border-radius: 6px;
    }

    .bubble.user {
      background: var(--vscode-editor-background);
      border: 1px solid var(--vscode-sideBar-background);;
    }

    .bubble.assistant {
      background: transparent;
      border-color: transparent;
    }

    .bubble pre {
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      color: var(--vscode-editor-foreground);
      background: var(--vscode-textCodeBlock-background);
      margin: 8px 0;
      border: 1px solid var(--vscode-panel-border);
    }

    .bubble code {
      font-family: var(--vscode-editor-font-family);
      font-size: 12px;
      color: var(--vscode-editor-foreground);
    }

    .bubble p {
      margin: 8px 0;
    }

    .bubble p:first-of-type {
      margin-top: 0;
    }

    .bubble p:last-of-type {
      margin-bottom: 0;
    }

    .composer {
      padding: 12px 16px 16px;
      background: var(--vscode-sideBar-background);
      flex-shrink: 0;
    }

    .input-wrap {
      position: relative;
    }

    textarea {
      width: 100%;
      min-height: 72px;
      resize: vertical;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      padding: 10px 12px 28px 12px;
      font-size: 13px;
      line-height: 1.4;
      outline: none;
      font-family: var(--vscode-font-family);
      resize: none;
      border: 1px solid var(--border-color);
    }

    textarea:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
    }

    textarea::placeholder {
      color: var(--vscode-input-placeholderForeground);
    }

    .send-button {
      position: absolute;
      right: 10px;
      bottom: 10px;
      width: 22px;
      height: 22px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      display: grid;
      place-items: center;
      background: transparent;
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .send-icon {
      width: 16px;
      height: 16px;
      fill: var(--vscode-foreground);
      transition: opacity 0.2s;
    }

    .send-icon.empty {
      opacity: 0.6;
    }

    .loading {
      display: none;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 12px;
      padding: 16px 10px;
      flex-shrink: 0;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid var(--vscode-progressBar-background);
      border-top-color: var(--accent);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 16px;
      background: var(--vscode-sideBar-background);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
      position: relative;
    }

    .header-left {
      position: relative;
      min-width: 0;
    }

    .session-selector {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }

    .session-selector:hover {
      background: var(--vscode-toolbar-hoverBackground);
    }

    .session-selector-title {
      font-size: 13px;
      color: var(--vscode-foreground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: left;
    }

    .session-selector-icon {
      width: 16px;
      height: 16px;
      fill: var(--vscode-foreground);
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .session-selector.open .session-selector-icon {
      transform: rotate(180deg);
    }

    .session-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 16px;
      right: 16px;
      background: var(--vscode-dropdown-background);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      max-height: 400px;
      z-index: 10000;
      display: none;
      box-shadow: 0 4px 12px var(--shadow);
      flex-direction: column;
    }

    .session-dropdown.show {
      display: flex;
    }

    .session-search-box {
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .session-search-input {
      width: 100%;
      padding: 6px 10px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
      font-size: 13px;
      outline: none;
      font-family: var(--vscode-font-family);
    }

    .session-search-input:focus {
      border-color: var(--vscode-focusBorder);
      outline: 1px solid var(--vscode-focusBorder);
    }

    .session-search-input::placeholder {
      color: var(--vscode-input-placeholderForeground);
    }

    .session-dropdown-list {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .session-dropdown-empty {
      padding: 20px;
      text-align: center;
      color: var(--vscode-descriptionForeground);
      font-size: 13px;
    }

    .session-dropdown-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s;
    }

    .session-dropdown-item:last-child {
      border-bottom: none;
    }

    .session-dropdown-item:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .session-dropdown-item.active {
      background: var(--vscode-list-activeSelectionBackground);
    }

    .session-dropdown-item.active .session-dropdown-summary {
      color: var(--vscode-list-activeSelectionForeground);
    }

    .session-dropdown-item.active .session-dropdown-time {
      color: var(--vscode-list-activeSelectionForeground);
      opacity: 0.8;
    }

    .session-dropdown-summary {
      font-size: 13px;
      color: var(--vscode-foreground);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-dropdown-time {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .session-dropdown-summary mark {
      background-color: var(--vscode-editor-findMatchHighlightBackground);
      color: var(--vscode-editor-foreground);
      padding: 0 2px;
      border-radius: 2px;
    }

    .header-back-btn {
      display: none;
    }

    .header-new-btn {
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
      background: none;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      flex-shrink: 0;
    }

    .header-new-btn:hover {
      background: var(--vscode-toolbar-hoverBackground);
    }

    .header-new-icon {
      width: 16px;
      height: 16px;
      fill: var(--vscode-foreground);
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }

    .chat-container.hidden {
      display: none;
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header-container">
    <div class="header-left">
      <div class="session-selector" id="sessionSelector">
        <div class="session-selector-title" id="sessionSelectorTitle">Deep Code</div>
        <svg class="session-selector-icon" viewBox="0 0 1024 1024" aria-hidden="true">
          <path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path>
        </svg>
      </div>
    </div>
    <button class="header-new-btn" id="newSessionBtn" title="New chat">
      <svg class="header-new-icon" viewBox="0 0 1024 1024" width="16" height="16" aria-hidden="true">
        <path d="M474 152m8 0l60 0q8 0 8 8l0 704q0 8-8 8l-60 0q-8 0-8-8l0-704q0-8 8-8Z"></path>
        <path d="M168 474m8 0l672 0q8 0 8 8l0 60q0 8-8 8l-672 0q-8 0-8-8l0-60q0-8 8-8Z"></path>
      </svg>
    </button>
    <div class="session-dropdown" id="sessionDropdown"></div>
  </div>

  <!-- 聊天视图 -->
  <div class="chat-container" id="chatContainer">
    <div class="messages" id="messages"></div>
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <span>Thinking...</span>
    </div>
    <div class="composer">
      <div class="input-wrap">
        <textarea id="prompt" placeholder="Write a prompt..." rows="3"></textarea>
        <button class="send-button" id="send" title="Send">
          <svg class="send-icon" id="sendIcon" viewBox="0 0 1024 1024" aria-hidden="true">
            <path d="M242.944 512L98.090667 139.605333c-10.069333-25.898667 15.189333-50.688 40.192-41.898666l3.968 1.706666 768 384a32 32 0 0 1 4.138666 54.741334l-4.138666 2.474666-768 384c-24.874667 12.416-51.925333-10.410667-45.44-36.138666l1.28-4.096L242.944 512 98.090667 139.605333 242.944 512zM187.818667 193.706667l111.36 286.293333h282.752a32 32 0 0 1 31.701333 27.648l0.298667 4.352a32 32 0 0 1-27.690667 31.701333l-4.309333 0.298667H299.093333l-111.317333 286.293333L824.405333 512 187.776 193.706667z" />
          </svg>
          <svg class="send-icon" id="stopIcon" viewBox="0 0 1024 1024" aria-hidden="true" style="display: none;">
            <path d="M777.6 553.6H246.4c-22.4 0-38.4-19.2-38.4-38.4 0-22.4 19.2-38.4 38.4-38.4h528c22.4 0 38.4 19.2 38.4 38.4 3.2 19.2-16 38.4-35.2 38.4z"></path>
            <path d="M512 1024C230.4 1024 0 793.6 0 512S230.4 0 512 0s512 230.4 512 512-230.4 512-512 512z m0-950.4C268.8 73.6 73.6 268.8 73.6 512S268.8 950.4 512 950.4 950.4 755.2 950.4 512 755.2 73.6 512 73.6z"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script nonce="{{nonce}}">
  const vscode = acquireVsCodeApi();
  const messages = document.getElementById("messages");
  const promptInput = document.getElementById("prompt");
  const sendButton = document.getElementById("send");
  const loading = document.getElementById("loading");
  const chatContainer = document.getElementById("chatContainer");
  const sessionSelector = document.getElementById("sessionSelector");
  const sessionSelectorTitle = document.getElementById("sessionSelectorTitle");
  const sessionDropdown = document.getElementById("sessionDropdown");
  const newSessionBtn = document.getElementById("newSessionBtn");
  const sendIcon = document.getElementById("sendIcon");
  const stopIcon = document.getElementById("stopIcon");

  let currentSessionId = null;
  let currentSessionStatus = null;
  let allSessions = [];
  let sessionSearchInput = null;
  let sessionDropdownList = null;

  function isProcessing() {
    return currentSessionStatus === "processing" || currentSessionStatus === "pending";
  }

  function addBubble(content, role) {
    const bubble = document.createElement("div");
    bubble.className = "bubble " + role;
    bubble.innerHTML = content;
    messages.appendChild(bubble);
    messages.scrollTop = messages.scrollHeight;
  }

  function setLoading(isLoading, status) {
    loading.classList.toggle("active", isLoading);
    if (status !== undefined) {
      currentSessionStatus = status;
    }

    // 切换图标
    if (isLoading) {
      sendIcon.style.display = "none";
      stopIcon.style.display = "block";
      sendButton.title = "Stop";
    } else {
      sendIcon.style.display = "block";
      stopIcon.style.display = "none";
      sendButton.title = "Send";
    }

    updateSendIconState();
  }

  function updateSendIconState() {
    const hasContent = promptInput.value.trim().length > 0;
    if (!isProcessing()) {
      sendIcon.classList.toggle("empty", !hasContent);
      sendButton.disabled = false;
    } else {
      sendButton.disabled = false; // 允许点击中断
    }
  }

  function clearMessages() {
    messages.innerHTML = "";
  }

  function updateSessionDropdown(sessions) {
    allSessions = sessions || [];
    sessionDropdown.innerHTML = "";

    // 创建搜索框
    const searchBox = document.createElement("div");
    searchBox.className = "session-search-box";
    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.className = "session-search-input";
    searchInput.placeholder = "Search sessions...";
    searchBox.appendChild(searchInput);
    sessionDropdown.appendChild(searchBox);

    // 创建列表容器
    const listContainer = document.createElement("div");
    listContainer.className = "session-dropdown-list";
    sessionDropdown.appendChild(listContainer);

    // 保存引用
    sessionSearchInput = searchInput;
    sessionDropdownList = listContainer;

    // 渲染所有会话
    renderFilteredSessions("");

    // 添加搜索事件
    searchInput.addEventListener("input", (e) => {
      renderFilteredSessions(e.target.value);
    });

    // 阻止搜索框点击事件冒泡
    searchInput.addEventListener("click", (e) => {
      e.stopPropagation();
    });
  }

  function renderFilteredSessions(searchQuery) {
    if (!sessionDropdownList) return;

    sessionDropdownList.innerHTML = "";
    const query = searchQuery.toLowerCase().trim();

    // 过滤会话
    const filteredSessions = allSessions.filter((session) => {
      const summary = (session.summary || "Untitled").toLowerCase();
      return summary.includes(query);
    });

    // 显示结果
    if (filteredSessions.length === 0) {
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "session-dropdown-empty";
      emptyDiv.textContent = query ? "No sessions found" : "No sessions yet";
      sessionDropdownList.appendChild(emptyDiv);
      return;
    }

    // 反转顺序（最新的在上面）
    const reversedSessions = [...filteredSessions].reverse();
    reversedSessions.forEach((session) => {
      const item = document.createElement("div");
      item.className = "session-dropdown-item";
      if (session.id === currentSessionId) {
        item.classList.add("active");
      }
      const date = new Date(session.updateTime).toLocaleString();

      // 高亮搜索关键字
      const summary = session.summary || "Untitled";
      const highlightedSummary = query
        ? summary.replace(new RegExp(`(${escapeRegExp(query)})`, 'gi'), '<mark>$1</mark>')
        : summary;

      item.innerHTML = `
        <div class="session-dropdown-summary">${highlightedSummary}</div>
        <div class="session-dropdown-time">${date}</div>
      `;
      item.addEventListener("click", () => {
        sessionDropdown.classList.remove("show");
        sessionSelector.classList.remove("open");
        vscode.postMessage({ type: "selectSession", sessionId: session.id });
      });
      sessionDropdownList.appendChild(item);
    });
  }

  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function toggleSessionDropdown() {
    const isOpen = sessionDropdown.classList.toggle("show");
    sessionSelector.classList.toggle("open", isOpen);

    // 打开时清空搜索框并聚焦
    if (isOpen && sessionSearchInput) {
      sessionSearchInput.value = "";
      renderFilteredSessions("");
      // 延迟聚焦，确保下拉框已完全显示
      setTimeout(() => {
        sessionSearchInput.focus();
      }, 100);
    }
  }

  // 点击其他地方关闭下拉框
  document.addEventListener("click", (event) => {
    if (!sessionSelector.contains(event.target) && !sessionDropdown.contains(event.target)) {
      sessionDropdown.classList.remove("show");
      sessionSelector.classList.remove("open");
    }
  });

  // 按 Escape 关闭下拉框
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape" && sessionDropdown.classList.contains("show")) {
      sessionDropdown.classList.remove("show");
      sessionSelector.classList.remove("open");
    }
  });

  promptInput.addEventListener("input", updateSendIconState);
  updateSendIconState();

  function sendPrompt() {
    // 如果正在处理，则中断（不检查输入框内容）
    if (isProcessing()) {
      vscode.postMessage({ type: "interrupt" });
      return;
    }

    // 检查输入内容
    const text = promptInput.value.trim();
    if (!text || sendButton.disabled) {
      return;
    }

    // 发送消息，不立即显示（等待后端返回渲染后的 HTML）
    promptInput.value = "";
    vscode.postMessage({ type: "userPrompt", prompt: text });
    updateSendIconState();
  }

  sessionSelector.addEventListener("click", (event) => {
    event.stopPropagation();
    toggleSessionDropdown();
  });

  newSessionBtn.addEventListener("click", () => {
    sessionDropdown.classList.remove("show");
    sessionSelector.classList.remove("open");
    vscode.postMessage({ type: "createNewSession" });
  });

  sendButton.addEventListener("click", sendPrompt);
  promptInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      if (event.shiftKey) {
        // Shift+回车：允许换行（默认行为）
        return;
      } else {
        // 回车：发送消息
        event.preventDefault();
        sendPrompt();
      }
    }
  });

  window.addEventListener("message", (event) => {
    const message = event.data;
    if (message.type === "initializeEmpty") {
      // 初始化空聊天
      clearMessages();
      sessionSelectorTitle.textContent = "New Conversation";
      currentSessionId = null;
      currentSessionStatus = message.status || null;
      setLoading(false, currentSessionStatus);
      // 如果消息中包含sessions，更新下拉框
      if (message.sessions && Array.isArray(message.sessions)) {
        updateSessionDropdown(message.sessions);
      } else if (allSessions.length > 0) {
        updateSessionDropdown(allSessions);
      }
    } else if (message.type === "loadSession") {
      // 加载已有对话
      currentSessionId = message.sessionId;
      clearMessages();
      sessionSelectorTitle.textContent = message.summary;
      
      // 加载历史消息
      if (message.messages && Array.isArray(message.messages)) {
        message.messages.forEach((msg) => {
          if (msg.role === "user") {
            addBubble(msg.html || msg.content, "user");
          } else if (msg.role === "assistant") {
            addBubble(msg.html || msg.content, "assistant");
          } else if (msg.role === "tool") {
            addBubble(msg.html || msg.content, "tool");
          }
        });
      }
      
      // 设置会话状态
      currentSessionStatus = message.status || null;
      const isCurrentlyProcessing = currentSessionStatus === "processing" || currentSessionStatus === "pending";
      setLoading(isCurrentlyProcessing, currentSessionStatus);
      
      // 如果消息中包含sessions，更新下拉框
      if (message.sessions && Array.isArray(message.sessions)) {
        updateSessionDropdown(message.sessions);
      } else if (allSessions.length > 0) {
        updateSessionDropdown(allSessions);
      }
    } else if (message.type === "showSessionsList") {
      // 更新对话列表下拉框
      updateSessionDropdown(message.sessions || []);
    } else if (message.type === "userMessage") {
      // 显示用户消息
      addBubble(message.html || "", "user");
    } else if (message.type === "assistant") {
      // 接收助手回复
      addBubble(message.html || "", "assistant");
    } else if (message.type === "loading") {
      // 加载状态
      const newStatus = message.value ? "processing" : currentSessionStatus;
      setLoading(Boolean(message.value), newStatus);
    }
  });

  // webview 准备就绪，请求初始数据
  vscode.postMessage({ type: "ready" });
</script>
</body>
</html>
